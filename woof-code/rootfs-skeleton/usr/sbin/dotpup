#!/bin/ash
#Lesser GPL licence v2 (http://www.fsf.org/licensing/licenses/lgpl.html)
# 10dec2013 shinobar: dotpup1, gtkdialog

export TEXTDOMAINDIR=/usr/share/locale
export TEXTDOMAIN=dotpup
eval_gettext () {
  local myMESSAGE=$(gettext "$1")
  eval echo \"$myMESSAGE\"
}

#how do i called
MYOPT=$1
[ "$MYOPT" ] || MYOPT=$(basename $0)
MYOPT=$(echo $MYOPT | tr -dc '0-9')

. /etc/DISTRO_SPECS

# has frugalinstaller? quickpet? # 29nov11 shinobar: sfs_load
which frugalinstaller >/dev/null 2>&1 && HASFRUGAL="yes" || HASFRUGAL=""
which quickpet >/dev/null 2>&1 && HASQUICKPET="yes" || HASQUICKPET=""
which f2fs-usb-installer >/dev/null 2>&1 && HASF2FS="yes" || HASF2FS=""

install_button() { #text1 text2 action icon
  echo '
  <hbox>
    <vbox homogeneous="true">
      <vbox>
        <text use-markup="true" xalign="1"><label>"<b>'${1}'</b>"</label></text>
        <text xalign="1"><label>'${2}'</label></text>
      </vbox>
    </vbox>
    <button>
      '`/usr/lib/gtkdialog/xml_button-icon $4 big`'
      <action>'"${3}"'</action>
      <action>EXIT:13</action>
    </button>
  </hbox>
  '
}

if [ "$HASFRUGAL" != "" ]; then
	FRUGALBUTTON=$(install_button \
		"$(gettext "Frugal Installer")" \
		"$(gettext "RECOMMENDED install style of Puppy")" \
		'frugalinstaller &' puppy_install.svg)
fi

BOOTFLASHBUTTON=$(install_button \
	"$(gettext "BootFlash USB installer")" \
	"$(gettext "Install to flash drive - destructive method")" \
	'bootflash &' flashcard_usb.svg )

FULLINSTALLBUTTON=$(install_button \
	"$(gettext "Universal installer")" \
	"$(gettext "Required for 'full' install")" \
	'puppyinstaller &' puppy_install.svg)

if [ "$HASF2FS" != "" ]; then
	F2FSBUTTON=$(install_button \
	"$(gettext "F2fs USB Installer")" \
	"$(gettext "Install Puppy on USB flash devices using f2fs file system")" \
	'f2fs-usb-installer &' puppy_install.svg)
fi

if [ -e /dev/sr0 ] ; then
	BURNISOBUTTON=$(install_button \
	"$(gettext "Burn ISO to DVD/CD")" \
	"$(gettext "Burn ISO to DVD/CD")" \
	'burniso2cd &' cd_burn.svg)
fi

#make dialog

PUPFRAME=""
if ! [ "$MYOPT" = "2" ] ; then
	PUPFRAME='
<frame '$(gettext 'Install to some other media')'>
  '"`/usr/lib/gtkdialog/xml_info 0 puppy_install.svg 50 "$(gettext "To install Puppy to a removable media, such as a USB drive, <b>please insert it right now</b>, before proceeding.")"`"' 
  <vbox margin="5" space-expand="true" space-fill="true">
    <vbox space-expand="false" space-fill="false">
      '$FRUGALBUTTON'
      '$BOOTFLASHBUTTON'
      '$F2FSBUTTON'
      '$FULLINSTALLBUTTON'
      '$BURNISOBUTTON'
    </vbox>
  </vbox>
</frame>'
fi
 
APPFRAME=""
if ! [ "$MYOPT" = "1" ] ; then
	PPMBUTTON=$(install_button \
	"$(gettext 'Puppy Package Manager')" \
	"$(gettext 'Install (and uninstall) packages from online repositories. Puppy packages are known as .PET packages.')" \
	'/usr/local/petget/pkg_chooser.sh &' package_sfs.svg
	)
	SFSGETBUTTON=$(install_button \
	"$(gettext 'Choose an SFS file from the official repo')" \
	"$(gettext 'SFS files are application combo-packs, very easy to install and uninstall.')" \
	'sfsget &' package_sfs.svg
	)
	SFSBUTTON=$(install_button \
	"$(gettext 'Load and unload SFS packages')" \
	"$(gettext 'Load and unload SFS packages with SFS-load')" \
	'sfs_load &' package_sfs.svg
	)
	APPFRAME='
<frame '$(gettext 'Install applications in the current Puppy')'>
  '"`/usr/lib/gtkdialog/xml_info fixed package_add.svg 50 "$(eval_gettext "These are the available options to install applications...")" ""`"'
  <vbox margin="5" space-expand="true" space-fill="true">
    <vbox space-expand="false" space-fill="false">
    '$PPMBUTTON'
    '$SFSGETBUTTON'
    '$SFSBUTTON'
    </vbox>
  </vbox>
</frame>'
fi

if [ "$PUPFRAME" ] && [ "$APPFRAME" ]; then
	export Puppy_Install='
	<window title="'$(gettext 'Install')'" icon-name="gtk-preferences">
	<vbox>
	  <notebook labels="'$(gettext 'Install Puppy')'|'$(gettext 'Install applications')'" space-expand="true" space-fill="true">
	    <vbox>
	      '$PUPFRAME'
	    </vbox>
	    <vbox>
	      '$APPFRAME'
	    </vbox>
	  </notebook>
	  <hbox space-expand="false" space-fill="false">
	    <button>
	      '"`/usr/lib/gtkdialog/xml_button-icon quit`"'
	      <label>'$(gettext 'Quit')'</label>
	    </button>
	  </hbox>
	</vbox>
	</window>'
else
	export Puppy_Install='
	<window title="'$(gettext 'Install')'" icon-name="gtk-preferences">
	<vbox>
	  '$PUPFRAME'
	  '$APPFRAME'
	  <hbox space-expand="false" space-fill="false">
          <button space-expand="false" space-fill="false">
          '"`/usr/lib/gtkdialog/xml_button-icon help`"'
          <label>'$(gettext 'Package Manager introduction webpage')'</label>
          <action>defaultbrowser http://puppylinux.com/development/package-management.htm & </action>
          </button>
          <text space-expand="true" space-fill="true"><label>""</label></text>
	    <button>
	      '"`/usr/lib/gtkdialog/xml_button-icon quit`"'
	      <label>'$(gettext 'Quit')'</label>
	    </button>
	  </hbox>
	</vbox>
	</window>'
fi

. /usr/lib/gtkdialog/xml_info gtk #build bg_pixmap for gtk-theme
#echo "$Puppy_Install" > /tmp/dotpup.xml #debug
gtkdialog --center -p Puppy_Install

###END###