#!/bin/sh
#(c) Copyright Barry Kauler 2006,2007 www.puppylinux.com
#2007 Lesser GPL licence v2 (/usr/share/doc/legal/lgpl-2.1.txt)

# Contributors: Dougal, rerwin, pizzasgood, TazOC, Karl Godt
#               Jemimah, 01micko, mavrothal, rodin.s, zigbert

#   https://www.x.org/wiki/Releases/
#-- Xorg X Server version should be 1.11+ --
#X11R7.6 (Released: 2010-12-20) should be the minimum version supported

if [ ! $DISPLAY ];then
  exec xorgwizard-cli #new script replaces this one...
fi

export TEXTDOMAIN=xorgwizard
export OUTPUT_CHARSET=UTF-8
. gettext.sh

. /etc/DISTRO_SPECS #120723
. /etc/rc.d/BOOTCONSTRAINED #120723

[ "`readlink /usr/bin/X`" = "" ] && ln -snf Xorg /usr/bin/X

if [ "$BOOT_DISABLEXORGWIZARD" = "yes" ];then #120723 refer /etc/rc.d/BOOTCONSTRAINED and 3builddistro.
 XORGPRELIM_XML="$(gettext 'The behaviour of Xorg is controlled by a configuration file, /etc/X11/xorg.conf. This was generated auto-matically at the first boot, but you may now edit it manually.')"
 XORGWIZ_XML=""
else
 XORGPRELIM_XML="$(gettext 'The behaviour of Xorg is controlled by a configuration file, /etc/X11/xorg.conf. You have a choice here, either to completely reconstruct the /etc/X11/xorg.conf file, or to modify the existing file.')"
 XORGWIZ_XML='
 <hbox border-width="7" space-expand="true" space-fill="true">
   <text xalign="0" use-markup="true" space-expand="true" space-fill="true"><label>"'$(gettext '<b>XorgWizard</b> completely reconstructs the /etc/X11/xorg.conf file, and X must not be running to do this. A reboot is required, and the Wizard will run in text mode, before X is launched.

NOTE: You can also run XorgWizard manually, without rebooting, by exiting from X to the commandline (see Shutdown menu) then run xorgwizard.')'"</label></text>
   <vbox space-expand="false" space-fill="false">
     <button>
       '"`/usr/lib/gtkdialog/xml_button-icon graphics_xorg.svg big`"'
       <action>EXIT:11</action>
     </button>
   </vbox>
 </hbox>
 <hseparator></hseparator>'
fi

MAIN1='
<window title="'$(gettext 'Xorg Video Wizard')'">
<vbox space-expand="true" space-fill="true">
  <notebook labels="'$(gettext 'Screen')'|'$(gettext 'Advanced')'" space-expand="true" space-fill="true">
    <vbox space-expand="true" space-fill="true">
      <frame '$(gettext 'Screen tuning')'>
      '"`/usr/lib/gtkdialog/xml_info fixed graphics.svg 60 "$(gettext '<b>Screen tuning</b> depends on the loaded video/graphics driver, so if correct resolution is not there, check the advanced tab...')"`"'
        <hbox border-width="7" space-expand="true" space-fill="true">
          <text xalign="0" use-markup="true" space-expand="true" space-fill="true"><label>"'$(gettext '<b>Change screen resolution</b>
How many vertical and horizontal pixels fits your screen.')'"</label></text>
          <vbox space-expand="false" space-fill="false">
            <button>
              '"`/usr/lib/gtkdialog/xml_button-icon screen_resolution.svg big`"'
              <action>EXIT:18</action>
            </button>
          </vbox>
        </hbox>
        <hseparator></hseparator>
        <hbox border-width="7" space-expand="true" space-fill="true">
          <text xalign="0" use-markup="true" space-expand="true" space-fill="true"><label>"'$(gettext '<b>Monitor gamma calibration</b>
This will adjust the monitor colors, including screen brightness.')'"</label></text>
            <vbox space-expand="false" space-fill="false">
              <button>
                '"`/usr/lib/gtkdialog/xml_button-icon screen_calibration.svg big`"'
                <action>EXIT:17</action>
              </button>
           </vbox>
         </hbox>
         <hseparator></hseparator>
         <hbox border-width="7" space-expand="true" space-fill="true">
           <text xalign="0" use-markup="true" space-expand="true" space-fill="true"><label>"'$(gettext '<b>X/Y correction</b>
If the screen is displaced or the width/height are wrong. This will modify the existing xorg.conf file. <b>Use with caution!</b>')'"</label></text>
           <vbox space-expand="false" space-fill="false">
             <button>
               '"`/usr/lib/gtkdialog/xml_button-icon screen_xy.svg big`"'
               <action>EXIT:13</action>
             </button>
           </vbox>
         </hbox>
       </frame>
    </vbox>
    <vbox space-expand="true" space-fill="true">
   
  <frame '$(gettext 'Manage xorg.conf')'>
   '"`/usr/lib/gtkdialog/xml_info fixed graphics.svg 60 "${XORGPRELIM_XML}"`"'

    '${XORGWIZ_XML}'

   <hbox border-width="7" space-expand="true" space-fill="true">
    <text xalign="0" use-markup="true" space-expand="true" space-fill="true"><label>"'$(gettext 'You can <b>manually edit</b> /etc/X11/xorg.conf, but note that you will need to exit from X afterward then restart X (see Shutdown menu). Click button to edit:')'"</label></text>
    <vbox space-expand="false" space-fill="false">
     <button>
      '"`/usr/lib/gtkdialog/xml_button-icon edit.svg big`"'
      <action>EXIT:15</action>
     </button>
    </vbox>
   </hbox>
  </frame>
  
    </vbox>
  </notebook>
  <hbox space-expand="false" space-fill="false">
    <button space-expand="false" space-fill="false">
      <label>'$(gettext "Quit")'</label>
      '"`/usr/lib/gtkdialog/xml_button-icon quit`"'
      <action>EXIT:quit</action>
    </button>
  </hbox>
</vbox>
</window>'


#do this code block if X is running...
if [ "`busybox ps | grep "\\.xinitrc"`" != "" ];then
 . /usr/lib/gtkdialog/xml_info gtk #build bg_pixmap for gtk-theme
 RETSTR="`echo "$MAIN1" | gtkdialog --stdin`"
 RETVAL="`echo "$RETSTR" | grep '^EXIT=' | cut -f 2 -d '"'`" #'geany

 case $RETVAL in
  11) #XorgWizard.
   . /etc/DISTRO_SPECS #120226 01micko fix for boot to desktop
   [ "$DISTRO_XORG_AUTO" = "yes" ] && sed -i "s/^DISTRO_XORG_AUTO='yes'/DISTRO_XORG_AUTO='no'/" /etc/DISTRO_SPECS #120226 temporary, fixes xorgwizard gui bug
   mv -f /etc/X11/xorg.conf /etc/X11/xorg.conf.prev 2>/dev/null
   NEXTWM="`cat /etc/windowmanager`"
   echo -n "$NEXTWM" > /etc/windowmanager #this makes change permanent.
   echo -n "$NEXTWM" > /tmp/wmexitmode.txt
   echo -n "ICONWIPE" >/var/local/pup_event_icon_change_flag #111108 Karl Godt: in case Xvesa selects different resolution.  120213 path changed from /tmp (see /sbin/clean_desk_icons)
   sync
   exec killall X
   ;;
  12) #xorgconfig
   xorgcfg
   /usr/lib/gtkdialog/box_ok "$(gettext 'Xorg wizard')" complete "$(gettext 'Changes to /etc/X11/xorg.conf will only take effect after X is restarted.')" " " "$(gettext 'Click OK button to restart X...')"
   exec restartwm
   ;;
  13) #xvidtune
   /usr/lib/gtkdialog/box_ok "$(gettext 'Xvidtune IMPORTANT HELP')" info "$(gettext "If you click the <b>Show</b> button, the adjusted settings will be what you want permanently. After hitting the <b>Quit</b> button, you will be given one last chance not to make the change permanent.")" "$(gettext 'Thus:')" "$(gettext "<b>Show</b> to record the settings (for later inclusion into xorg.conf)")" "$(gettext "<b>Quit</b> to exit Xvidtune.")" " " "$(gettext 'Please note that Xvidtune does not work with all video hardware, meaning that changing the settings will cause no change on the screen.')" &
   XMSGPID=$!
   MODELINE0="`xvidtune | grep '^"[0-9]'`" #'geanyfix.
   pupkill $XMSGPID
   if [ ! "$MODELINE0" = "" ];then
    xmessage -bg orange -title "$(gettext 'Xvidtune: Modeline')" -buttons Write:10,Quit:11 "$(gettext 'The new modeline is:')
$MODELINE0

$(gettext 'Note, you will have to restart X for it to take effect. If it messes')
`gettext \"up X, edit from commandline 'mp /etc/X11/xorg.conf' and comment-out\"`
`gettext \"the 'UseModes' line (do not delete it) in the Monitor section.\"`

`gettext \"To insert this into /etc/X11/xorg.conf, click 'Write' button...\"`
`gettext \"To exit without changing xorg.conf, click 'Quit' button...\"`"
    if [ $? -eq 10 ];then
     PATTERNA="s/.*#modes0modeline0/ ModeLine $MODELINE0 #modes0modeline0/g"
     cat /etc/X11/xorg.conf | sed -e "$PATTERNA" > /tmp/xorg.conf.new
     sync
     cat /tmp/xorg.conf.new | sed -e 's/#.*UseModes/UseModes/g' > /etc/X11/xorg.conf
     sync
    fi
   fi
   exit
   ;;
  15) #edit xorg.conf
   exec defaulttexteditor /etc/X11/xorg.conf
   ;;
  17) #xgamma-gui
   exec xgamma-gui 
   ;;
  18) #resolution changer
   exec xrandrshell
   ;;
 esac
 exit
fi

###END###
