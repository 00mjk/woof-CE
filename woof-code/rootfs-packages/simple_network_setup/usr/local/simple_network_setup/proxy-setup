#!/bin/bash
#setup proxy server for wget

#set -x

export TEXTDOMAIN=proxy-setup
export OUTPUT_CHARSET=UTF-8

# old files
rm -f /etc/profile.d/ftp_proxy
rm -f /etc/profile.d/http_proxy

TITLE=$(gettext 'Proxy server setup')

ENABLE_PROXY=false
PROXY_SERVER="http://foo.org"
PORT=8080
PROXY_SERVER_FILE='/etc/profile.d/proxy_setup'

if [ -f "$PROXY_SERVER_FILE" ] ; then
	ENABLE_PROXY=true
fi

if [ -f /var/local/proxy_server ] ; then
	read ps < /var/local/proxy_server
	case $ps in
		"http:"*)  PROTOCOL="http://"  ; PROXY=${ps//http:\/\/} ;;
		"https:"*) PROTOCOL="https://" ; PROXY=${ps//https:\/\/} ;;
		"ftp:"*)   PROTOCOL="ftp://"   ; PROXY=${ps//ftp:\/\/} ;;
		"ftps:"*)  PROTOCOL="ftp://"   ; PROXY=${ps//ftps:\/\/} ;;
		*)         PROTOCOL="http://"  ; PROXY=${ps//http:\/\/} ;;
	esac
	if grep -q '@' <<< "${PROXY}" ; then
		IFS="@" read -r userpass addressport <<< "${PROXY}"
		if grep -q ':' <<< "${userpass}" ; then
			IFS=":" read -r USERNAME PASS <<< "${userpass}"
		fi
		if grep -q ':' <<< "${addressport}" ; then
			IFS=":" read -r HOSTNAME PORT <<< "${addressport}"
		else
			HOSTNAME=${addressport}
		fi
		PROXY_SERVER=${PROTOCOL}${HOSTNAME}
	else
		if grep -q ':' <<< "${PROXY}" ; then
			IFS=":" read -r HOSTNAME PORT <<< "${PROXY}"
		else
			HOSTNAME=${PROXY}
		fi
		PROXY_SERVER=${PROTOCOL}${HOSTNAME}
	fi
fi

#-------------------------

while [ 1 ] ; do

	#-- DEFAULTS --

	DEFAULT_PROXY_SERVER=""
	DEFAULT_USERNAME=""
	DEFAULT_PASS1=""
	DEFAULT_PASS2=""

	[ "$PROXY_SERVER" != "" ] && DEFAULT_PROXY_SERVER="<default>${PROXY_SERVER}</default>"
	[ "$USERNAME" != "" ] && DEFAULT_USERNAME="<default>${USERNAME}</default>"
	[ "$PORT" != "" ] && DEFAULT_PORT="<default>${PORT}</default>"
	if [ "$PASS" != "" ] ; then
		DEFAULT_PASS1="<default>${PASS}</default>"
		DEFAULT_PASS2="<default>${PASS}</default>"
	fi
	[ "$PASS1" != "" ] && DEFAULT_PASS1="<default>${PASS1}</default>"
	[ "$PASS2" != "" ] && DEFAULT_PASS2="<default>${PASS2}</default>"

	#-- DIALOG
	MSG1=$(gettext 'If you connect to the Internet through a proxy server, tick the checkbox and fill in the fields, (leave Username/Password blank if not needed)')
	export PROXY_SETUP_WINDOW='<window title="'${TITLE}'" icon-name="gtk-network" window-position="1">
<vbox space-expand="true" space-fill="true">
	'$(/usr/lib/gtkdialog/xml_info fixed /usr/local/lib/X11/pixmaps/www48.png 48 "$MSG1")'
	<checkbox active="'${ENABLE_PROXY}'">
		<label>'$(gettext 'Enable Internet connection through proxy server')'</label>
		<variable>ENABLE_PROXY</variable>
		<action>if true enable:PROXY_SERVER</action>
		<action>if true enable:USERNAME</action>
		<action>if true enable:PASS1</action>
		<action>if true enable:PASS2</action>
		<action>if false disable:PROXY_SERVER</action>
		<action>if false disable:PASS1</action>
		<action>if false disable:PASS2</action>
		<action>if false disable:USERNAME</action>
	</checkbox>
	<frame '$(gettext 'Proxy Server')'>
		<hbox>
			<text xalign="0" space-expand="false"><label>'$(gettext 'Hostname:')'</label></text>
			<entry space-expand="true" sensitive="'${ENABLE_PROXY}'">
				<variable>PROXY_SERVER</variable>
				'${DEFAULT_PROXY_SERVER}'
			</entry>
		</hbox>
		<hbox>
			<text xalign="0" space-expand="false"><label>'$(gettext 'Port:')'</label></text>
			<entry space-expand="true" sensitive="'${ENABLE_PROXY}'">
				<variable>PORT</variable>
				'${DEFAULT_PORT}'
			</entry>
		</hbox>
	</frame>
	<frame '$(gettext 'Proxy Authentification')'>
		<hbox>
			<text xalign="0" space-expand="false"><label>'$(gettext 'Username:')'</label></text>
			<entry space-expand="true" sensitive="'${ENABLE_PROXY}'">
				<variable>USERNAME</variable>
				'${DEFAULT_USERNAME}'
			</entry>
		</hbox>
		<hbox space-expand="true" space-fill="true">
			<text xalign="0" space-expand="false"><label>'$(gettext 'Password:')'</label></text>
			<entry space-expand="true" caps-lock-warning="true"  tooltip-markup="'$(gettext 'Enter password')'" visibility="false" sensitive="'${ENABLE_PROXY}'">
				<variable>PASS1</variable>
				'${DEFAULT_PASS1}'
			</entry>
		</hbox>
		<hbox space-expand="true" space-fill="true">
			<text xalign="0" space-expand="false"><label>'$(gettext 'Confirm password:')'</label></text>
			<entry caps-lock-warning="true"  tooltip-markup="'$(gettext 'Enter password')'" visibility="false" sensitive="'${ENABLE_PROXY}'">
				<variable>PASS2</variable>
				'${DEFAULT_PASS2}'
			</entry>
		</hbox>
	</frame>
	<hbox>
		<button>
			'$(/usr/lib/gtkdialog/xml_button-icon ok)'
			<label>'$(gettext 'OK')'</label>
			<action type="exit">OK</action>
		</button>
		<button>
			'$(/usr/lib/gtkdialog/xml_button-icon cancel)'
			<label>'$(gettext 'Cancel')'</label>
			<action type="exit">Cancel</action>
		</button>
	</hbox>
</vbox>

</window>
'

	. /usr/lib/gtkdialog/xml_info gtk
	I=$IFS; IFS=""
	for STATEMENTS in  $(gtkdialog --center --program PROXY_SETUP_WINDOW); do
		eval $STATEMENTS
	done
	IFS=$I

	[ "$EXIT" != "OK" ] && break

	if [ "$ENABLE_PROXY" = "true" ] ; then

		if [ "$PASS1" != "$PASS2" ] ; then
			/usr/lib/gtkdialog/box_ok "$TITLE" error "$(gettext 'Sorry, the password entries are not the same')"
			continue
		fi
		if [ "$USERNAME" ] && [ ! "$PASS1" -o ! "$PASS2" ] ; then
			/usr/lib/gtkdialog/box_ok "$TITLE" error "$(gettext 'You must specify a password')"
			continue
		fi
		if [ "$PASS1" -a ! "$USERNAME" ] ; then
			/usr/lib/gtkdialog/box_ok "$TITLE" error "$(gettext 'You must specify a username')"
			continue
		fi
		if [ "$PROXY_SERVER" != "" ] ; then
			case $PROXY_SERVER in
				"http:"*)  PROTOCOL="http://"  ; HOSTNAME=${PROXY_SERVER//http:\/\/}  ;;
				"https:"*) PROTOCOL="https://" ; HOSTNAME=${PROXY_SERVER//https:\/\/} ;;
				"ftp:"*)   PROTOCOL="ftp://"   ; HOSTNAME=${PROXY_SERVER//ftp:\/\/}   ;;
				"ftps:"*)  PROTOCOL="ftps://"  ; HOSTNAME=${PROXY_SERVER//ftps:\/\/}  ;;
				*)         PROTOCOL="http://"  ; HOSTNAME=${PROXY_SERVER//http:\/\/}  ;;
			esac
			if [ "$USERNAME" = "" ] ; then
				PROXY="${HOSTNAME}:${PORT}"
			else
				PROXY="${USERNAME}:${PASS1}@${HOSTNAME}:${PORT}"
			fi
			(
				echo "export http_proxy='${PROTOCOL}${PROXY}'"
				echo "export https_proxy='${PROTOCOL}${PROXY}'"
				echo "export rsync_proxy='${PROTOCOL}${PROXY}'"
				echo "export ftp_proxy='${PROTOCOL}${PROXY}'"
				echo "export ftps_proxy='${PROTOCOL}${PROXY}'"
				echo "export HTTP_PROXY='${PROTOCOL}${PROXY}'"
				echo "export HTTPS_PROXY='${PROTOCOL}${PROXY}'"
				echo "export RSYNC_PROXY='${PROTOCOL}${PROXY}'"
				echo "export FTP_PROXY='${PROTOCOL}${PROXY}'"
				echo "export FTPS_PROXY='${PROTOCOL}${PROXY}'"
			) > ${PROXY_SERVER_FILE}
			echo -n "${PROTOCOL}${PROXY}" > /var/local/proxy_server
		fi

		/usr/lib/gtkdialog/box_ok "$TITLE" info "$(gettext 'Great, you have modified the proxy server settings. Note, you can see the result in files /etc/profile.d/proxy_setup. However, MOST IMPORTANT, you must reboot for this to take effect')"
		break

	else
		/usr/lib/gtkdialog/box_ok "$TITLE" info "$(gettext 'You have chosen NOT to use a proxy server. Note, if you previously did have a proxy server enabled, you MUST REBOOT for the change to take effect')"
		rm -f ${PROXY_SERVER_FILE}
		break
	fi

done

### END ###
