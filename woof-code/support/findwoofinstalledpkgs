#!/bin/bash
#(c) Copyright Barry Kauler 2009, puppylinux.com
#this script finds all builtin packages in Puppy Linux.
#121028 exclude pkgs that go into devx only from woof-installed-packages.

export LANG=C

. ./_00func
. ./DISTRO_SPECS #has DISTRO_BINARY_COMPAT, DISTRO_COMPAT_VERSION
[ ! "$DISTRO_DB_SUBNAME" ] && DISTRO_DB_SUBNAME="$DISTRO_COMPAT_VERSION" #121102 fallback if DISTRO_DB_SUBNAME not defined in file DISTRO_SPECS.
source_pkgs_specs    # ./DISTRO_PKGS_SPECS-

echo "Creating file woof-installed-packages..."

#remove comments from PKGS_SPECS_TABLE... make sure '|' on end... get rid of old |+udev,+whatever on end...
PKGS_SPECS_TABLE="`echo "$PKGS_SPECS_TABLE" | grep -v '^#' | grep -v '^$' | tr '\t' ' ' | tr -s ' ' | tr '+' '&' | sed -e 's%|&.*%%' | tr '&' '+' | sed -e 's% #.*%%' -e 's% $%%' -e 's%$%|%' -e 's%||$%|%'`"

run_findpkgs #find all packages that will be used in the Puppy build...

PKGS_EXE="$(echo "$PKGS_SPECS_TABLE" | grep '^yes|' | grep -v 'exe>dev')"
PKGS_DEV="$(echo "$PKGS_SPECS_TABLE" | grep '^yes|' | grep 'exe>dev')"

#need to find exactly what has gone into the build and the devx...
echo -n "" > /tmp/woof-installed-packages-tmp
echo -n "" > /tmp/devx-only-installed-packages-tmp #121028
(
	cat status/findpkgs_FINAL_PKGS-${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION} |
	while read ONELINE
	do
		#ex: :a52dec:|compat|Packages-puppy-wary5-official|a52dec-0.7.4-w5|a52dec|0.7.4-w5||BuildingBlock|68K||a52dec-0.7.4-w5.pet||A free ATSC A52 stream decoder|puppy|wary5||
		IFS="|" read -r F1 F2 F3 ADBENTRY <<< $ONELINE
		IFS="|" read -r F4 F5 F6 ETC <<< $ADBENTRY
		GENERICNAMES="$F1"
		NAMEONLY="$F5"
		for AGENERICNAME in ${GENERICNAMES//:/ }
		do
			if ( echo "$PKGS_EXE" | grep -q "^yes|${AGENERICNAME}|" ) ; then
				echo $ADBENTRY 
				continue
			fi
			if ( echo "$PKGS_DEV" | grep -q "^yes|${AGENERICNAME}|" ) ; then
				echo "$ADBENTRY" >> /tmp/devx-only-installed-packages-tmp
				continue
			fi
		done
	done
) >> /tmp/woof-installed-packages-tmp
sync

# added for rootfs-packages
[ -f /tmp/rootfs-packages.specs ] && cat /tmp/rootfs-packages.specs >> /tmp/woof-installed-packages-tmp

sort --key=1 --field-separator="|" /tmp/woof-installed-packages-tmp > woof-installed-packages
if [ -s /tmp/devx-only-installed-packages-tmp ];then
 sort --key=1 --field-separator="|" /tmp/devx-only-installed-packages-tmp > devx-only-installed-packages
fi

###END###
