#!/bin/ash
# $1 quiet mode indicator - ex: q
#this is called from 'init', runs as parallel process.
#110710 rewritten for kernel with hid and usb drivers builtin, and without my usb-storage patch.
#110713 have put my usb-storage patch back in to kernel (2.6.39-3).
#120330 mmc drives may be slow to become ready, so add them in here.
#170525 usb stuff rewritten with no dmesg stuff

#wait for usb partitions to become available...
#entries in /sys/block show up, but ex /sys/block/sda/sda1 takes a bit longer...
#note, if usb card-reader plugged in but no cards inserted, this will timeout...
#note, will also timeout if usb optical drive (sr), but ok, they need extra time...

CNTUSB=0
USBDRVS="$(find /sys/block -maxdepth 1 -name 'sd*' -o -name 'sr*' | xargs -n 1 readlink 2>/dev/null | grep '/usb[0-9]')"
while [ "$USBDRVS" = "" ]; do
	sleep 1
	[ "${1}" ] || echo -en "\\033[1;33m.\\033[0;39m" >/dev/console #yellow dot
	USBDRVS="$(find /sys/block -maxdepth 1 -name 'sd*' -o -name 'sr*' | xargs -n 1 readlink 2>/dev/null | grep '/usb[0-9]')"
	CNTUSB=$(($CNTUSB + 1))
	[ $CNTUSB -gt 4 ] && break
done 

for ONEDRV in $USBDRVS; do
	ONEDRV=${ONEDRV##*/}
	ALLUSBDRVS="${ALLUSBDRVS}${ONEDRV} "
	CNTUSB=0
	while [ ! -e /sys/block/${ONEDRV}/${ONEDRV}1 ]; do
		sleep 1
		[ "${1}" ] || echo -en "\\033[1;31m.\\033[0;39m" >/dev/console #red dot
		CNTUSB=$(($CNTUSB + 1))
		[ $CNTUSB -gt 1 ] && break
	done
done

echo -n "${ALLUSBDRVS% }" > /tmp/flag-usb-ready

#120330 probe for mmc drives...
MMCDRVS=""
if [ "`grep '^mmc' /tmp/ALLDRVS0`" = "" ]; then  #find out if already available.
	[ "`lsmod | grep '^mmc'`" != "" ] && MMCDRVS="`find /sys/block -maxdepth 1 -name 'mmc*' | tr '\n' ' '`"
	[ "$MMCDRVS" = " " ] && MMCDRVS=""
fi

[ "$MMCDRVS" ] && echo -n " ${MMCDRVS}" >> /tmp/flag-usb-ready

exit
